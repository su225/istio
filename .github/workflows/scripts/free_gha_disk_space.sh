#!/usr/bin/env bash

#
# Frees disk space on GitHub-hosted runner.
#

# See
#   https://github.community/t/bigger-github-hosted-runners-disk-space/17267/9
#   https://github.com/actions/virtual-environments/issues/709
#   https://github.com/apache/flink/blob/master/tools/azure-pipelines/free_disk_space.sh

set -ex

echo ">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"
echo "Disk space BEFORE cleanup"
echo "--------------------------------------------------------------------------------"

df -h

echo "<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<"

#

echo
echo ">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"
echo "Listing large packages (top 50)"
echo "--------------------------------------------------------------------------------"

dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -k1nr | head -50

echo "<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<"

#

echo
echo ">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"
echo "Removing large directories"
echo "--------------------------------------------------------------------------------"

sudo rm -rf /usr/share/dotnet/

echo "<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<"

#

echo
echo ">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"
echo "Disk space AFTER cleanup"
echo "--------------------------------------------------------------------------------"

df -h

echo "<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<"
